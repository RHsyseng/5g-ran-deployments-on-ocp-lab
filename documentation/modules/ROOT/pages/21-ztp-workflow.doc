= ZTP Worlflow
include::_attributes.adoc[]
:profile: 5g-ran-lab

As mentioned, Zero Touch Provisioning (ZTP) leverages multiple products[..link to ZTP components] to deploy OpenShift Container Platform clusters using a GitOps approach. While the workflow starts when the site is connected to the network and ends with the CNF workload deployed and running on the site nodes, it can be logically divided into two different stages: provisioning of the SNO and applying the desired configuration, which in our case is applying the validated RAN DU profile.

IMPORTANT: The workflow does not need any intervention, so ZTP automatically will configure the SNO once it is provisioned. However, two stages are clearly differentiated.

You start the workflow by creating declarative configurations for the provisioning of your OpenShift clusters. This configuration is called `siteConfig` and it is understood by ZTP using an specific kustomize plugin called https://github.com/openshift-kni/cnf-features-deploy/tree/master/ztp/siteconfig-generator-kustomize-plugin[siteconfig-generator]. This CR contains all the necessary information for RHACM and Assisted Installer to provision your node or nodes. Basically, it will create ISO images with the the defined configuration that are delivered to the edge nodes to begin the installation process. The images are used to repeatedly provision large numbers of nodes efficiently and quickly, allowing you keep up with requirements from the field for far edge nodes. 

image::ztp_workflow_0.png[ZTP Workflow 0]

image::ztp_workflow_1.png[ZTP Workflow 1]

image::ztp_workflow_2.png[ZTP Workflow 2]

image::ztp_workflow_3.png[ZTP Workflow 3]



Once a cluster is provisioned, the day-2 configuration defined in multiple `PolicyGenTemplate` custom resources will be automatically applied. `PolicyGenTemplate`custom resource is understood by the ZTP using an specific kustomize plugin called https://github.com/openshift-kni/cnf-features-deploy/tree/master/ztp/policygenerator-kustomize-plugin[policy-generator]. In telco RAN DU nodes, this configuration includes the installation of the common telco operators, common configuration for RAN and specific configuration (SR-IOV or performance settings) for each site since it is very dependant on the hardware.

Notice that if, later on, you want to apply a new configuration or replace an existing configuration  you must use a new `policyGenTemplate` to do that.

image::ztp_gitops_flow.png[External Resource Reconciler]

The deployment of the clusters includes:

* Installing the host operating system (RHCOS) on a blank server.
* Deploying OpenShift Container Platform.
* Creating cluster policies via `PolicyGenTemplate` and site subscriptions via `SiteConfig`
* Leveraging a GitOps deployment topology for a develop once, deploy anywhere model.
* Making the necessary network configurations to the server operating system.
* Deploying profile Operators and performing any needed software-related configuration, such as performance profile, PTP, and SR-IOV.
* Downloading images needed to run workloads (CNFs).