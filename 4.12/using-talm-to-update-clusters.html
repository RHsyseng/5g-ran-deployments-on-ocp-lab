<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using TALM to Update Clusters :: LAB - 5G RAN Deployments on OpenShift</title>
    <link rel="canonical" href="https://labs.sysdeseng.com/4.12/using-talm-to-update-clusters.html">
    <link rel="prev" href="check-deployment-is-finished.html">
    <link rel="next" href="troubleshooting-tips.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/solutions/telecommunications" target="_blank"><img src="../_/img/Logo-Red_Hat-A-Reverse-RGB.png" height="40px" alt="Red Hat Telco Solutions"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://labs.sysdeseng.com">LAB - 5G RAN Deployments on OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="4.12" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Welcome</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#contributors">Contributors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="introduction.html">Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#lab-aim">Who is this lab aimed at? </a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="introduction.html#lab-software-versions">Lab Software Versions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="acronyms.html">Acronyms used in the lab</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="5g-ran-context.html">5G Ran Context</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#low-latency">Low Latency</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#numa-nodes">NUMA Nodes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#huge-pages">Huge Pages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#cpu-pinning">CPU Pinning</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#irq-load-balancing">IRQ Load Balancing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#dpdk">DPDK</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#oot-drivers">OoT Drivers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#cpu-reduction-tuning">Tuning for CPU Reduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#vran-accelerators">vRAN Dedicated Accelerators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5g-ran-context.html#ptp">PTP</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="sno-intro.html">Introduction to Single Node OpenShift (SNO)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sno-intro.html#5g-ran">5G Radio Access Network</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sno-intro.html#things-keep-mind">Things to keep in mind</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sno-intro.html#deployments">Deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sno-intro.html#extra-information">Extra information</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="telco-related-infra-operators-intro.html">Introduction to Telco Related Infrastructure Operators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="telco-related-infra-operators-intro.html#node-tuning-operator">Node Tuning Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="telco-related-infra-operators-intro.html#sriov-operator">SR-IOV Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="telco-related-infra-operators-intro.html#ptp-operator">PTP Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="telco-related-infra-operators-intro.html#accelerators-operators">Accelerators Operators</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ztp-intro.html">Introduction to Zero Touch Provisioning (ZTP)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="ocp-gitops.html">OpenShift GitOps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="ocp-gitops.html#gitops">GitOps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ocp-gitops.html#gitops-principles">GitOps Principles</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ocp-gitops.html#gitops-patterns-ocp">GitOps Patterns on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ocp-gitops.html#directories-vs-branches">Directories vs Branches</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ocp-gitops.html#direct-commit-to-main">Direct commit to main</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ocp-gitops.html#prs-review-cycles">Pull Requests and review cycles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ocp-gitops.html#gitops-ocp">GitOps on OpenShift</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="ztp-at-scale.html">Hub Management Components</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="ztp-at-scale.html#rhacm">Red Hat Advanced Cluster Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ztp-at-scale.html#mce">Multicluster Engine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ztp-at-scale.html#ai">Infrastructure Operator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="ztp-at-scale.html#gitops-operator">GitOps Operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ztp-at-scale.html#sitegen">SiteGen</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ztp-at-scale.html#policygen">PolicyGen</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ztp-at-scale.html#talm">Topology Aware Lifecycle Manager</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="ztp-workflow.html">ZTP Workflow</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ztp-workflow.html#takeaways">Takeaways</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="rhacm-policies.html">RHACM Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="rhacm-policies.html#policy-framework">Policy Framework</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="rhacm-policies.html#policies">Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="rhacm-policies.html#policy-status">Policy Status</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="rhacm-policies.html#policy-remediation">Policy Remediation</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="managing-at-scale.html">Managing at Scale</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="managing-at-scale.html#inform-policies">Inform Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="managing-at-scale.html#olm-subscriptions">OLM Subscriptions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="managing-at-scale.html#cluster-policies">Cluster Policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="talm.html">Topology Aware Lifecycle Manager (TALM)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="talm.html#inform-policies">Default Inform Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="talm.html#cgu">Cluster Group Upgrade</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="talm.html#autocreation-cgu">Auto Creation of CGUs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="talm.html#phase-labels">Phase labels</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="talm.html#waves">Policy Waves</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="talm.html#talm-precache">Precaching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="talm.html#talm-backup">Backup &amp; Recovery</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="policygen-deepdive.html">PolicyGen Deepdive</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="policygen-deepdive.html#policygen-implementation">PolicyGen Implementation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="policygen-deepdive.html#kustomize-plugins">Kustomize Plugins</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#siteconfig-generator">SiteConfigGenerator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#policy-generator">Policy Generator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="policygen-deepdive.html#5g-ran-profile">5G RAN Profile</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#workload-partitioning">Workload Partitioning</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#kubelet-tuning">Kubelet Tuning</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#sctp">SCTP</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#hide-container-mount">Container Mount Hiding</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#recovery-optimization">Recovery Optimization</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#monitoring-footprint">Monitoring Operator Config</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#ocp-console">Console Operator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#networking-diags">Networking Operator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#operatorhub">OperatorHub</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#ptp-operator">PTP Operator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#sr-iov">SR-IOV</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#nto">Node Tuning Operator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#local-storage">Local Storage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="policygen-deepdive.html#logs">Log Collector and Forwarder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="policygen-deepdive.html#siteconfig-templating">SiteConfig Templating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="policygen-deepdive.html#policies-templating">Policies Templating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="policygen-deepdive.html#kustomize-plugins-locally">Running Kustomize Plugins Locally</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deployment-considerations.html">Deployment Considerations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deployment-considerations.html#hardware-configurations">Hardware configurations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deployment-considerations.html#bios-settings">Bios Settings</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deployment-considerations.html#networking">Networking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deployment-considerations.html#disconnected-environments">Disconnected Environments</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deployment-considerations.html#connected-proxy">Connected through proxy</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deployment-considerations.html#fully-disconnected">Fully disconnected</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="deployment-considerations.html#git-repo-structure">Git Repository Structure</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="lab-environment-introduction.html">Introduction to the Lab Environment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-environment-introduction.html#git-server">Git Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-environment-introduction.html#container-registry">Container Registry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-environment-introduction.html#openshift-hub-cluster">OpenShift Hub Cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="crafting-deployments-iac.html">Crafting Deployment&#8217;s IaC</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crafting-deployments-iac.html#introduction-to-siteconfig">Introduction to the SiteConfig</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="crafting-deployments-iac.html#crafting-our-own-siteconfig">Crafting our own SiteConfig</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="crafting-deployments-iac.html#git-repository">Git Repository</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="crafting-deployments-iac.html#baremetal-node-details">Bare Metal Node Details</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="crafting-deployments-iac.html#pre-reqs">Deployment Prerequesites</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="crafting-deployments-iac.html#siteconfig">SiteConfig</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="crafting-cluster-telco-related-infra-operators-configs.html">Crafting Cluster and Telco Related Infrastructure Operators Configs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crafting-cluster-telco-related-infra-operators-configs.html#crafting-common-policies">Crafting Common Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crafting-cluster-telco-related-infra-operators-configs.html#crafting-group-policies">Crafting Group Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crafting-cluster-telco-related-infra-operators-configs.html#crafting-zone-policies">Crafting Zone Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crafting-cluster-telco-related-infra-operators-configs.html#crafting-site-policies">Crafting Site Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crafting-cluster-telco-related-infra-operators-configs.html#crafting-testing-policies">Crafting testing Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crafting-cluster-telco-related-infra-operators-configs.html#configure-kustomization-for-policies">Configure Kustomization for Policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="running-the-deployment.html">Running the Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="running-the-deployment.html#deploying-ztp-gitops-pipeline">Deploying the ZTP GitOps Pipeline</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="running-the-deployment.html#deploying-sno-using-gitops-pipeline">Deploying the SNO Cluster using the ZTP GitOps Pipeline</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="monitoring-the-deployment.html">Monitoring the Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring-the-deployment.html#monitoring-deployment-webui">Monitoring the Deployment via the WebUI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="monitoring-the-deployment.html#monitoring-deployment-cli">Monitoring the Deployment via the CLI</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="managing-existing-clusters.html">Managing Existing Clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="check-deployment-is-finished.html">Check SNO Deployment is finished</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="check-deployment-is-finished.html#check-sno-deployment-webui">Check SNO Deployment has Finished via the WebUI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="check-deployment-is-finished.html#check-sno-deployment-cli">Check SNO Deployment has Finished via the CLI</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="using-talm-to-update-clusters.html">Using TALM to update clusters</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#verify-talm">Verifying the TALM state</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#upgrade-policy-creation">Creating the upgrade PGT</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#upgrade-cgu-creation">Applying the upgrade</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#talm-backup-precache">Backup and pre-cache</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#talm-upgrade">Triggering the upgrade</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="troubleshooting-tips.html">Troubleshooting Tips</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="troubleshooting-tips.html#verification-lab">Verification of the lab status</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="troubleshooting-tips.html#git-registry">Git repository and registry</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="troubleshooting-tips.html#sno2">SNO2 virtual machine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="troubleshooting-tips.html#hub">Hub cluster</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="troubleshooting-tips.html#dns">DNS resolution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="troubleshooting-tips.html#argocd-red">ArgoCD sync not working</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="troubleshooting-tips.html#sno2-down">SNO2 is down after syncing Argo applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="troubleshooting-tips.html#policies-blank">Policies not showing in the Governance console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="troubleshooting-tips.html#policies-not-applied">Policies not applied</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="troubleshooting-tips.html#olm-bug">OLM Bug</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="common-pitfalls.html">Common Pitfalls</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-pitfalls.html#exec-probes-cpu-pinning">Exec Probes and CPU Pinning</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-pitfalls.html#energy-saving-hw-profiles">Energy Saving Hardware Profiles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-pitfalls.html#secure-boot-oot-unsigned-drivers">Secure Boot and Unsigned OoT Drivers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-pitfalls.html#sriov-node-drain">SR-IOV Node Drain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="common-pitfalls.html#pod-disruption-budgets">Pod Disruption Budgets</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="closing-thoughts.html">Closing Thoughts</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="lab-environment.html">Lab Environment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lab-environment.html#lab-requirements">Lab Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="lab-environment.html#lab-deployment">Lab Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#install-kcli">Install kcli</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#install-oc-kubectl">Install oc/kubectl CLIs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#configure-disconnected-network">Configure Disconnected Network</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#configure-local-dns-dhcp-server">Configure Local DNS/DHCP Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#configure-local-dns-as-primary-server">Configure Local DNS as Primary Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#disable-firewall">Disable Firewall</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#install-sushytools">Install Sushy Tools</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#configure-disconnected-registry">Configure Disconnected Registry</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#configure-git-server">Configure Git Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#configure-ntp-server">Configure NTP Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#configure-access-to-cluster-apps">Configure Access to Cluster Apps</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#create-openshift-nodes-vms">Create OpenShift Nodes VMs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#deploy-openshift-hub-cluster">Deploy OpenShift Hub Cluster</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#configure-openshift-hub-cluster">Configure OpenShift Hub Cluster</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#deploy-openshift-hub-cluster-operators">Deploy OpenShift HUB Cluster Operators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="lab-environment.html#deploy-sno1-cluster-without-ztp">Deploy SNO1 Cluster (without ZTP)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">LAB - 5G RAN Deployments on OpenShift</a></li>
    <li><a href="using-talm-to-update-clusters.html">Using TALM to update clusters</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/RHsyseng/5g-ran-deployments-on-ocp-lab/edit/lab-4.12/documentation/modules/ROOT/pages/using-talm-to-update-clusters.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Using TALM to Update Clusters</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this section, we will perform a platform upgrade to both managed clusters using the pre-cache and backup feature implemented in the Topology Aware Lifecycle Manager (TALM) operator. The pre-cache feature prepares the maintenance operation in the managed clusters by pulling the required artifacts prior to the upgrade. The reasoning behind this feature is that SNO spoke clusters may have limited bandwidth to the container registry, which will make it difficult for the upgrade to complete within the required time. In order to ensure the upgrade can fit within the maintenance window, the required artifacts need to be present on the spoke cluster prior to the upgrade. The idea is pre-caching all the images needed for the platform and operator upgrade on the node, so they are not pulled at upgrade time. Do it in a maintenance window(s) before the upgrade maintenance window.</p>
</div>
<div class="paragraph">
<p>The backup feature, on the other hand, implements a procedure for rapid recovery of a SNO in the event of a failed upgrade that is unrecoverable. The SNO needs to be restored to a working state with the previous version of OCP without requiring a re-provision of the application(s).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The backup feature only allows SNOs to be restored, this is not applicable to any other kind of OpenShift clusters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s upgrade our both clusters. First of all, let&#8217;s verify the TALM operator is running in our <strong>hub cluster</strong>:</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="verify-talm"><a class="anchor" href="#verify-talm"></a>Verifying the TALM state</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Below commands must be executed from the workstation host if not specified otherwise.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig get operators</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                                                   AGE
advanced-cluster-management.open-cluster-management    16h
lvms-operator.openshift-storage                        16h
multicluster-engine.multicluster-engine                16h
openshift-gitops-operator.openshift-operators          16h
topology-aware-lifecycle-manager.openshift-operators   16h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, double check there is no problem with the Pod. Notice that the name of the Pod is cluster-group-upgrade-controller-manager, based on the name of the upstream project <a href="https://github.com/openshift-kni/cluster-group-upgrades-operator">Cluster Group Upgrade Operator</a>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig get pods,sa,deployments -n openshift-operators</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                                                           READY   STATUS    RESTARTS        AGE
pod/cluster-group-upgrades-controller-manager-6d6fc98d-6cnf9   2/2     Running   1 (2d14h ago)   2d14h
pod/gitops-operator-controller-manager-c6bc6db9f-5z752         1/1     Running   0               2d15h

NAME                                                                SECRETS   AGE
serviceaccount/builder                                              1         2d16h
serviceaccount/cluster-group-upgrades-controller-manager            1         2d14h
serviceaccount/cluster-group-upgrades-operator-controller-manager   1         2d14h
serviceaccount/default                                              1         2d16h
serviceaccount/deployer                                             1         2d16h
serviceaccount/gitops-operator-controller-manager                   1         2d15h

NAME                                                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/cluster-group-upgrades-controller-manager   1/1     1            1           2d14h
deployment.apps/gitops-operator-controller-manager          1/1     1            1           2d15h</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, let&#8217;s take a look at the cluster group upgrade (CGU) CRD managed by TALM. If we pay a closer look we will notice that an already completed CGU was applied to SNO2. As we mentioned in <a href="talm.html#inform-policies">inform policies</a> section, all policies are not enforced, the user has to create the proper CGU resource to enforce them. However, when using ZTP, we want our cluster provisioned and configured automatically. This is where TALM will step through the set of created policies (inform) and will enforce them once the cluster was successfully provisioned. Therefore, the configuration stage starts without any intervention ending up with our OpenShift cluster ready to process workloads.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It&#8217;s possible that you get <code>UpgradeNotCompleted</code>, if that&#8217;s the case you need to wait for the remaining policies to be applied. You can check policies status <a href="https://console-openshift-console.apps.hub.5g-deployment.lab/multicloud/governance/policies">here</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig get cgu -A</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAMESPACE     NAME   AGE     STATE       DETAILS
ztp-install   sno2   3h29m   Completed   All clusters are compliant with all the managed policies</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-snos-kubeconfigs"><a class="anchor" href="#getting-snos-kubeconfigs"></a>Getting the SNO clusters kubeconfigs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous sections we have deployed the <code>sno2</code> cluster and attached the <code>sno1</code> cluster. Before we continue with TALM, let&#8217;s grab the kubeconfigs for both cluster since we will need them for the next sections.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig -n sno1 extract secret/sno1-admin-kubeconfig --to=- &gt; ~/5g-deployment-lab/sno1-kubeconfig
oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig -n sno2 extract secret/sno2-admin-kubeconfig --to=- &gt; ~/5g-deployment-lab/sno2-kubeconfig</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="upgrade-policy-creation"><a class="anchor" href="#upgrade-policy-creation"></a>Creating the upgrade PGT</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create an upgrade PGT in inform mode, as usual, that will apply and upgrade the SNOs located in Europe (binding rule: <code>du-zone: "europe"</code>), SNO1 and SNO2 clusters. This file needs to be created in the ztp-repository Git repo that we have created.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF &gt; ~/5g-deployment-lab/ztp-repository/site-policies/fleet/active/zone-europe-upgrade-412-5.yaml
---
apiVersion: ran.openshift.io/v1
kind: PolicyGenTemplate
metadata:
  name: "europe-snos-upgrade"
  namespace: "ztp-policies"
spec:
  bindingRules:
    du-zone: "europe"
    logicalGroup: "active"
  mcp: "master"
  remediationAction: inform
  sourceFiles:
    - fileName: ClusterVersion.yaml
      policyName: "version-412-5"
      metadata:
        name: version
      spec:
        channel: "stable-4.12"
        desiredUpdate:
          force: false
          version: "4.12.5"
          image: "infra.5g-deployment.lab:8443/openshift/release-images@sha256:fd65cebce150bac3c622e30e7f762d3173575ae3541b3a7648819cb63e9b63a4"
      status:
        history:
          - version: "4.12.5"
            state: "Completed"
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify the kustomization.yaml inside the site-policies folder, so it includes this new PGT and eventually will be applied by ArgoCD.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -i "/- group-du-sno.yaml/a \ \ - zone-europe-upgrade-412-5.yaml" ~/5g-deployment-lab/ztp-repository/site-policies/fleet/active/kustomization.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then commit all the changes:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ~/5g-deployment-lab/ztp-repository/
git add site-policies/fleet/active/zone-europe-upgrade-412-5.yaml site-policies/fleet/active/kustomization.yaml
git commit -m "adds upgrade policy"
git push origin main</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once committed, in a couple of minutes we will see a new policy in the multicloud RHACM console. As noticed, the policy named <code>europe-snos-upgrade-version-412-5</code> has a violation. However, only one cluster is not compliant. If we check the policy information we will see that this policy is only targeting SNO2 cluster. That&#8217;s because the SNO1 cluster does not have the labels zone-europe and active logicalGroup that the PGT is targeting in its binding rule.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Notice in the following picture that there are policies not applying to any cluster. Those are policies targeting the test environment. This is expected since we do not have any clusters in the test environment, e.g, no clusters are labeled with the proper label for testing: logicalGroup=test.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/talm_upgrade_policy_01.png" alt="TALM upgrade policy 1">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add the proper labels to the production cluster SNO1:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig label managedcluster sno1 du-zone=europe logicalGroup=active</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">managedcluster.cluster.open-cluster-management.io/sno1 labeled</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="upgrade-cgu-creation"><a class="anchor" href="#upgrade-cgu-creation"></a>Applying the upgrade</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point, we need to create a Cluster Group Upgrade (CGU) resource that will start the upgrade process. In our case, the process will be divided into two stages:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run a pre-cache of the new OCP release prior to start the upgrade process.</p>
</li>
<li>
<p>Before running the upgrade, a backup will be done.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="talm-backup-precache"><a class="anchor" href="#talm-backup-precache"></a>Backup and pre-cache</h3>
<div class="paragraph">
<p>Let&#8217;s create the CGU. In this case, we will apply the managed policy (europe-snos-upgrade-version-412-5) to both clusters at the same time (maxConcurrency is 2). Notice that the CGU is disabled, this is suggested if we are going to run the precaching feature. This means, that once the precaching process is done we are ready to start the upgrade process by enabling the CGU. This idea is related to the compliance of a maintenance window in an enterprise.</p>
</div>
<div class="paragraph">
<p>Remember that several gigabytes of artifacts needs to be downloaded to the spoke for a full upgrade. SNO spoke clusters may have limited bandwidth to the hub cluster hosting the registry, which will make it difficult for the upgrade to complete within the required time. In order to ensure the upgrade can fit within the maintenance window, the required artifacts need to be present on the spoke cluster prior to the upgrade. Therefore, the process is split up into two stages as mentioned.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/timing.png" alt="TALM maintenance window concept">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s apply the CGU to our hub cluster:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig apply -f -
---
apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: update-europe-snos
  namespace: ztp-policies
spec:
  preCaching: true
  backup: true
  clusters:
  - sno1
  - sno2
  enable: false
  managedPolicies:
  - europe-snos-upgrade-version-412-5
  remediationStrategy:
    maxConcurrency: 2
    timeout: 240
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once applied, we can see that the status moved to <code>PrecacheSpecIsWellFormed</code>. This means that the first step in our process is executing the pre-cache.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig get cgu -A</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAMESPACE      NAME                 AGE     STATE                      DETAILS
ztp-install    sno2                 3h40m   Completed                  All clusters are compliant with all the managed policies
ztp-policies   update-europe-snos   10s     PrecacheSpecIsWellFormed   Precaching spec is valid and consistent</code></pre>
</div>
</div>
<div class="paragraph">
<p>Connecting to any of our spoke clusters we can see a new job being created called pre-cache.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Notice that pre-cache job can take up to 5m to be created.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/sno2-kubeconfig -n openshift-talo-pre-cache get job pre-cache</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME        COMPLETIONS   DURATION   AGE
pre-cache   0/1           64s        64s</code></pre>
</div>
</div>
<div class="paragraph">
<p>This job creates a Pod that will run the precache process. As we can see below, 183 images need to be downloaded from our local registry to mark the task as successful.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/sno2-kubeconfig logs job/pre-cache -n openshift-talo-pre-cache -f</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">upgrades.pre-cache 2023-03-16T12:59:10+00:00 DEBUG Release index image processing done
58ff6e48f95bf6b444150290f481ad6fc6051e76defccf3611bdc2f9ddc1cccc
upgrades.pre-cache 2023-03-16T12:59:10+00:00 DEBUG Operators index is not specified. Operators will not be pre-cached
upgrades.pre-cache 2023-03-16T12:59:10+00:00 DEBUG Pulling quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:006e37a1f141eb219364a501767fb4a26210908385eef9576af00b55d8225ecb [1/183]
upgrades.pre-cache 2023-03-16T12:59:10+00:00 DEBUG Pulling quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:01b510f238c0a8ad44df44d4aba3d0d2cfa429153ce3f451095484815f5746fd [2/183]
upgrades.pre-cache 2023-03-16T12:59:11+00:00 DEBUG Pulling quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:02c9c2a2ef5941156a767d40abe900a669a8237a8444a3974b360c326a21ffc3 [3/183]
.
.
.
upgrades.pre-cache 2023-03-16T13:13:37+00:00 DEBUG Pulling quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:fe86e187b2664371923282d88426a183ccddc75305d9ee5b6e64a082d179b596 [182/183]
upgrades.pre-cache 2023-03-16T13:13:48+00:00 DEBUG Pulling quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:fec91120672f68e7671b6f1fc17becf5aee9c72e540e046874a216d68bd04ffc [183/183]
upgrades.pre-cache 2023-03-16T13:13:48+00:00 DEBUG Image pre-cache done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the precache is done, the CGU state moves to <code>NotEnabled</code>. At this moment, TALM is waiting for acknowledging the start of the upgrade.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It can take up to 5 minutes for the CGU to report the new state.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig get cgu -A</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAMESPACE      NAME                 AGE   STATE        DETAILS
ztp-install    sno2                 4h    Completed    All clusters are compliant with all the managed policies
ztp-policies   update-europe-snos   20m   NotEnabled   Not enabled</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="talm-upgrade"><a class="anchor" href="#talm-upgrade"></a>Triggering the upgrade</h3>
<div class="paragraph">
<p>Now that the pre-cache is done, we can trigger the update. As we said earlier, before the update is actually executed a backup will be done so we can rollback. In order to trigger the update we need to enable the CGU:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig patch cgu update-europe-snos -n  ztp-policies --type merge --patch '{"spec":{"enable":true}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the CGU state moved to <code>InProgress</code>, which means, the upgrade process has started. In the details you can see that the backup is in progress.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig get cgu -A</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAMESPACE      NAME                 AGE    STATE        DETAILS
ztp-install    sno2                 4h6m   Completed    All clusters are compliant with all the managed policies
ztp-policies   update-europe-snos   25m    InProgress   Backup in progress for 2 clusters</code></pre>
</div>
</div>
<div class="paragraph">
<p>Connecting to any of our spoke clusters we can see a new job being created called backup-agent.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Notice that backup job can take up to 5m to be created.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/sno1-kubeconfig get jobs -A</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAMESPACE                              NAME                                                              COMPLETIONS   DURATION   AGE
assisted-installer                     assisted-installer-controller                                     1/1           38m        4h47m
openshift-marketplace                  51f5147f46ba2fcbd47cc8cba3f7a6f28f7cc23b267e380ac5a1ee1de87d962   1/1           11s        4h2m
openshift-operator-lifecycle-manager   collect-profiles-27982845                                         1/1           7s         39m
openshift-operator-lifecycle-manager   collect-profiles-27982860                                         1/1           118s       24m
openshift-operator-lifecycle-manager   collect-profiles-27982875                                         1/1           7s         9m2s
openshift-talo-backup                  backup-agent                                                      0/1           30s        30s
openshift-talo-pre-cache               pre-cache                                                         1/1           16m        25m</code></pre>
</div>
</div>
<div class="paragraph">
<p>This job basically runs a Pod that will execute a recovery procedure and will store all required data into the /var/recovery folder of each spoke.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/sno2-kubeconfig logs job/backup-agent -n openshift-talo-backup -f</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">INFO[0000] ------------------------------------------------------------
INFO[0000] Cleaning up old content...
INFO[0000] ------------------------------------------------------------
INFO[0000] Old directories deleted with contents
INFO[0000] Old contents have been cleaned up
INFO[0004] Available disk space : 155.49 GiB; Estimated disk space required for backup: 340.63 MiB
INFO[0004] Sufficient disk space found to trigger backup
INFO[0004] Upgrade recovery script written
INFO[0004] Running: bash -c /var/recovery/upgrade-recovery.sh --take-backup --dir /var/recovery
INFO[0004] ##### Thu Mar 16 13:24:20 UTC 2023: Taking backup
INFO[0004] ##### Thu Mar 16 13:24:20 UTC 2023: Wiping previous deployments and pinning active
INFO[0005] error: Out of range deployment index 1, expected &lt; 1
INFO[0005] Deployment 0 is now pinned
INFO[0005] ##### Thu Mar 16 13:24:21 UTC 2023: Backing up container cluster and required files
INFO[0005] Certificate /etc/kubernetes/static-pod-certs/configmaps/etcd-serving-ca/ca-bundle.crt is missing. Checking in different directory
INFO[0005] Certificate /etc/kubernetes/static-pod-resources/etcd-certs/configmaps/etcd-serving-ca/ca-bundle.crt found!
INFO[0006] found latest kube-apiserver: /etc/kubernetes/static-pod-resources/kube-apiserver-pod-6
INFO[0006] found latest kube-controller-manager: /etc/kubernetes/static-pod-resources/kube-controller-manager-pod-9
INFO[0006] found latest kube-scheduler: /etc/kubernetes/static-pod-resources/kube-scheduler-pod-8
INFO[0007] found latest etcd: /etc/kubernetes/static-pod-resources/etcd-pod-3
INFO[0009] 519d313c23c0fea1d1aed4366dd935663680a6a253bbb254ae7071ff3c66899c
INFO[0009] etcdctl version: 3.5.6
INFO[0009] API version: 3.5
INFO[0009] {"level":"info","ts":"2023-03-16T13:24:26.056Z","caller":"snapshot/v3_snapshot.go:65","msg":"created temporary db file","path":"/var/recovery/cluster/snapshot_2023-03-16_132422.db.part"}
INFO[0009] {"level":"info","ts":"2023-03-16T13:24:26.068Z","logger":"client","caller":"v3@v3.5.6/maintenance.go:212","msg":"opened snapshot stream; downloading"}
INFO[0009] {"level":"info","ts":"2023-03-16T13:24:26.068Z","caller":"snapshot/v3_snapshot.go:73","msg":"fetching snapshot","endpoint":"https://192.168.125.40:2379"}
INFO[0010] {"level":"info","ts":"2023-03-16T13:24:26.991Z","logger":"client","caller":"v3@v3.5.6/maintenance.go:220","msg":"completed snapshot read; closing"}
INFO[0011] {"level":"info","ts":"2023-03-16T13:24:27.355Z","caller":"snapshot/v3_snapshot.go:88","msg":"fetched snapshot","endpoint":"https://192.168.125.40:2379","size":"92 MB","took":"1 second ago"}
INFO[0011] {"level":"info","ts":"2023-03-16T13:24:27.355Z","caller":"snapshot/v3_snapshot.go:97","msg":"saved","path":"/var/recovery/cluster/snapshot_2023-03-16_132422.db"}
INFO[0011] Snapshot saved at /var/recovery/cluster/snapshot_2023-03-16_132422.db
INFO[0011] Deprecated: Use `etcdutl snapshot status` instead.
INFO[0011]
INFO[0011] {"hash":1194329918,"revision":85030,"totalKey":7098,"totalSize":91566080}
INFO[0011] snapshot db and kube resources are successfully saved to /var/recovery/cluster
INFO[0018] Command succeeded: rsync -a /etc/ /var/recovery/etc/
INFO[0019] Command succeeded: rsync -a /usr/local/ /var/recovery/usrlocal/
INFO[0023] Command succeeded: rsync -a /var/lib/kubelet/ /var/recovery/kubelet/
INFO[0023] ##### Thu Mar 16 13:24:40 UTC 2023: Backup complete
INFO[0023] ------------------------------------------------------------
INFO[0023] backup has successfully finished ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once backups are finished for all clusters, the CGU state will move to <code>BackupCompleted</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig get cgu -A</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAMESPACE      NAME                 AGE    STATE             DETAILS
ztp-install    sno2                 4h9m   Completed         All clusters are compliant with all the managed policies
ztp-policies   update-europe-snos   28m    BackupCompleted   Backup is completed for all clusters</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, if we connect to any of our spoke clusters we can see that the upgrade process is actually taking place.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/sno2-kubeconfig get clusterversion,nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                                         VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
clusterversion.config.openshift.io/version   4.12.3    True        True          4m2s    Working towards 4.12.5: 213 of 829 done (25% complete), waiting on config-operator, machine-api

NAME                          STATUS   ROLES                         AGE    VERSION
node/sno2.5g-deployment.lab   Ready    control-plane,master,worker   5h7m   v1.25.4+a34b9e9</code></pre>
</div>
</div>
<div class="paragraph">
<p>Meanwhile, the clusters are upgrading we can take a look at the <a href="https://console-openshift-console.apps.hub.5g-deployment.lab/multicloud/governance/policies">multicloud console</a> and see that there is a new policy in enforce mode:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/talm_upgrade_policy_03.png" alt="TALM upgrade policy 3">
</div>
</div>
<div class="paragraph">
<p>Moving to the Infrastructure &#8594; Cluster section of the multicloud console we can also graphically see the upgrading of both clusters:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/talm_upgrade_policy_04.png" alt="TALM upgrade policy 3">
</div>
</div>
<div class="paragraph">
<p>Finally, our clusters are upgraded:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/sno2-kubeconfig get clusterversion,nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                                         VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
clusterversion.config.openshift.io/version   4.12.5    True        False         9m13s   Cluster version is 4.12.5

NAME                          STATUS   ROLES                         AGE     VERSION
node/sno2.5g-deployment.lab   Ready    control-plane,master,worker   5h56m   v1.25.4+a34b9e9</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/sno1-kubeconfig get clusterversion,nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                                         VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
clusterversion.config.openshift.io/version   4.12.5    True        False         33m     Cluster version is 4.12.5

NAME                      STATUS   ROLES                         AGE   VERSION
node/openshift-master-0   Ready    control-plane,master,worker   18h   v1.25.4+a34b9e9</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that now the upgrade policy <code>europe-snos-upgrade-version-412-5</code> is now compliant on both clusters. See that, in order to save resources, the enforce policy is removed once the CGU is successfully applied.</p>
</div>
<div class="paragraph">
<p>And finally, the CGU will be <code>Completed</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc --kubeconfig ~/5g-deployment-lab/hub-kubeconfig get cgu -A</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAMESPACE      NAME                 AGE     STATE       DETAILS
ztp-install    sno2                 5h26m   Completed   All clusters are compliant with all the managed policies
ztp-policies   update-europe-snos   106m    Completed   All clusters are compliant with all the managed policies</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/talm_upgrade_policy_05.png" alt="TALM upgrade policy 5">
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="check-deployment-is-finished.html">Check SNO Deployment is finished</a></span>
  <span class="next"><a href="troubleshooting-tips.html">Troubleshooting Tips</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
